C51 COMPILER V9.52.0.0   MAIN                                                              04/08/2016 21:50:07 PAGE 1   


C51 COMPILER V9.52.0.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN main.OBJ
COMPILER INVOKED BY: D:\Program Files\Keil\C51\BIN\C51.EXE main.c LARGE BROWSE DEBUG OBJECTEXTEND TABS(2)

line level    source

   1          #include "pwm.h"
   2          #include "timer.h"
   3          #include "Exti.h"
   4          #include "Lcd.h"
   5          #include "config.h"
   6          
   7          
   8          #define TLIN P0&0x03//红外信号线（3路）取P0的低2位 P00最右
   9          
  10          sbit k =P1^6;//定义红外开关输入端口
  11          unsigned char g;//常数g
  12           
  13          //电机模块管脚
  14          //将右电机信号线接P25 pwm0
  15          //将左电机信号线接P25 pwm1
  16          
  17          
  18          extern u8 time_counter=0;//timer0 计数
  19          extern u8 line_counter=0;//黑线 计数
  20          extern u8 time1_counter=0;//timer1 计数
  21          extern bit update_flag=0;//timer0 计数标记
  22          
  23          //压线标志位
  24          bit L1=0;//最右侧标志位
  25          bit L2=0;
  26          bit L3=0;
  27          bit L4=0;//最左侧标志位
  28          
  29          u8 flag=0;
  30          
  31          bit tl_flag=0;//0正常前行 1 turn left
  32          bit over_flag=0; //
  33          
  34          u16 timer1_reg=65536UL - (MAIN_Fosc/40UL);
  35          
  36          
  37          /***************************向前走*****************************/
  38          void forward() 
  39          {
  40   1          pwm_left(speed);
  41   1          pwm_right(speed);
  42   1      }
  43          /**************************停止*****************************/
  44          void stop() {pwm_left(0); pwm_right(0);}  
  45          
  46          /*左转90度，自动恢复*/
  47          void turn_left()
  48          {
  49   1        //调试参数修改转弯模式
  50   1          pwm_left(0);
  51   1          pwm_right(speed);
  52   1        //调试参数，1-255
  53   1          delay_ms(2000);
  54   1          pwm_left(speed);
  55   1          pwm_right(speed);
C51 COMPILER V9.52.0.0   MAIN                                                              04/08/2016 21:50:07 PAGE 2   

  56   1      }
  57          
  58          /*右转90度，自动恢复*/
  59          void turn_right()
  60          {
  61   1        //调试参数修改转弯模式
  62   1          pwm_left(speed);
  63   1          pwm_right(0);
  64   1        //调试参数，0-65536
  65   1          delay_ms(2000);
  66   1          pwm_left(speed);
  67   1          pwm_right(speed);
  68   1      }
  69          
  70          void adjust_left()
  71          {
  72   1        u8 temp=TLIN;
  73   1          pwm_left(0);
  74   1          pwm_right(speed);
  75   1        //????????
  76   1        //??????
  77   1        //??130 delay_ms(100)
  78   1        //??170 delay_ms(180) 1?150 too samll
  79   1        //
  80   1          delay_ms(220);
  81   1          //?????
  82   1          for(;temp!=0x00;temp=TLIN)//???????
  83   1          {
  84   2          }
  85   1          //??
  86   1          pwm_left(speed);
  87   1          pwm_right(0);
  88   1          //????
  89   1          delay_ms(200);
  90   1          //????
  91   1          pwm_left(speed);
  92   1          pwm_right(speed);
  93   1          return;
  94   1          
  95   1      }
  96          void adjust_right()
  97          {
  98   1          u8 temp=TLIN;
  99   1          // 右转
 100   1          pwm_left(speed);
 101   1          pwm_right(0);
 102   1          
 103   1          delay_ms(200);
 104   1      
 105   1          for(;temp!=0x00;temp=TLIN)//
 106   1          {
 107   2        //    delay_ms(10);
 108   2          }
 109   1      
 110   1          pwm_left(0);
 111   1          pwm_right(speed);
 112   1          //
 113   1          delay_ms(150);
 114   1          //
 115   1          pwm_left(speed);
 116   1          pwm_right(speed);
 117   1          return;
C51 COMPILER V9.52.0.0   MAIN                                                              04/08/2016 21:50:07 PAGE 3   

 118   1      
 119   1      }
 120          
 121          /************************
 122          //左转可调，自动恢复
 123          //t1:保持左转状态时间 1-65536
 124          //t2:回调时间 1-65536
 125          *************************/
 126          void turn_leftn(u16 t1,u16 t2)
 127          {
 128   1        //调试参数修改转弯模式
 129   1          pwm_left(0);
 130   1          pwm_right(speed);
 131   1        //:保持左转状态时间
 132   1          delay_ms(t1);
 133   1          //回调
 134   1          //回调时pwm比需要计算、调试
 135   1          pwm_left(speed);
 136   1          pwm_right(0);
 137   1            //回调时间
 138   1          delay_ms(t2);
 139   1          //恢复前行
 140   1          pwm_left(speed);
 141   1          pwm_right(speed);
 142   1      }
 143          
 144          /************************
 145          //右转可调，支持转弯后回调
 146          //t1:保持右转状态时间 1-255
 147          //t2:回调时间 1-255
 148          *************************/
 149          void turn_rightn(u16 t1,u16 t2)
 150          {
 151   1        
 152   1        //调试参数修改转弯模式
 153   1          pwm_left(speed);
 154   1          pwm_right(0);
 155   1        //保持右转状态时间
 156   1          delay_ms(t1);
 157   1          
 158   1          //回调
 159   1          //回调时pwm比需要计算、调试
 160   1          pwm_left(0);
 161   1          pwm_right(speed);
 162   1            //回调时间
 163   1          delay_ms(t2);
 164   1          
 165   1          //恢复前行
 166   1          pwm_left(speed);
 167   1          pwm_right(speed);
 168   1      
 169   1      }
 170          
 171          /*****************************检测前面是否有小车*******************************/
 172          
 173          void check()
 174          {
 175   1        if(k==1)
 176   1          g=1;
 177   1        else 
 178   1          g=0;
 179   1      }
C51 COMPILER V9.52.0.0   MAIN                                                              04/08/2016 21:50:07 PAGE 4   

 180          
 181          
 182          void Line_Count();
 183          
 184          
 185          void Inline()   //检测黑线信号，检测到黑线时变为高电平，平时低电平
 186          {
 187   1        Line_Count();
 188   1        if(tl_flag)
 189   1        {
 190   2          //左转，定时器1控制左转时间
 191   2          pwm_left(0);
 192   2          pwm_right(speed);
 193   2          
 194   2          TR1=0;
 195   2          TH1 = (u8)(timer1_reg>> 8);
 196   2          TL1 = (u8)timer1_reg;
 197   2          TR1=1;
 198   2        }
 199   1        
 200   1        
 201   1        switch(TLIN)
 202   1        {
 203   2          //没检测到黑线时，直行
 204   2          case 0x00:    forward();                  break;
 205   2          
 206   2          //右边检测到黑线时,左转
 207   2          case 0x01:  adjust_left();                break;
 208   2          
 209   2          //左边检测到黑线时，右转
 210   2          case 0x02:    adjust_right();             break;
 211   2              
 212   2          //不可能
 213   2          case 0x03:     forward();                 break;
 214   2          
 215   2      //
 216   2          default:  break;
 217   2        }
 218   1      
 219   1      }
 220          
 221          void Line_Count()           //检测黑线条数
 222          {
 223   1        if(update_flag==1)            //定时1s到
 224   1          {
 225   2            update_flag=0;            //标记位清空
 226   2            if(line_counter <=1)        //如果该时间内没有第二根线
 227   2            {
 228   3              line_counter=0;           //黑线数量清空  
 229   3              TR0=0;                    //关闭计时器
 230   3            }
 231   2          }
 232   1          if(line_counter >=3)            //超车标志线
 233   1          {
 234   2            over_flag=1;//超车标志位置1
 235   2          }
 236   1      }
 237          
 238          /*************************主函数***********************************/
 239          main()
 240          { 
 241   1        char dis_code[10]={"---cm"};
C51 COMPILER V9.52.0.0   MAIN                                                              04/08/2016 21:50:07 PAGE 5   

 242   1        Initialize_LCD();// init LCD1602
 243   1        PCA_Init();//pwm初始化
 244   1        Timer_config();
 245   1        EXTI_config();
 246   1        EA=1;
 247   1      
 248   1        check();//初始化检测前方小车
 249   1        forward(); //直行
 250   1      
 251   1        ClearLine(1);                 //LCD删行
 252   1        ClearLine(2);
 253   1          
 254   1        //调试用 1-255
 255   1        delay_ms(200);
 256   1      PutString(1,1,"Line_counter:");       //LCD显示   
 257   1          WriteChar(1,7,line_counter);
 258   1          PutString(2,1,dis_code);
 259   1      //    PutString(2,7,"mode:");
 260   1        while(1)
 261   1        { 
 262   2          Inline();
 263   2        //  pwm_left(speed);
 264   2        //  pwm_right(0);
 265   2      
 266   2         }
 267   1       }
 268          
 269          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    523    ----
   CONSTANT SIZE    =     24    ----
   XDATA SIZE       =      7      20
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      7    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
