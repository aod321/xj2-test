C51 COMPILER V9.52.0.0   MAIN                                                              04/07/2016 17:40:32 PAGE 1   


C51 COMPILER V9.52.0.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN main.OBJ
COMPILER INVOKED BY: F:\Keil\C51\BIN\C51.EXE main.c LARGE BROWSE DEBUG OBJECTEXTEND TABS(2)

line level    source

   1          #include "config.h"
   2          #include "pwm.h"
   3          #include "timer.h"
   4                
   5          #define speed 150//正常行驶速度 0-255
   6          #define TLIN P0&0x07//红外信号线（3路）取P0的低3位 P00最右
   7          
   8          sbit k =P1^6;//定义红外开关输入端口
   9          unsigned char g;//常数g
  10           
  11          //电机模块管脚
  12          //将右电机信号线接P25 pwm0
  13          //将左电机信号线接P25 pwm1
  14          
  15          sbit led1 = P0^4;  //循迹模块管脚
  16          sbit led2 = P0^5;
  17          sbit led3 = P0^6;
  18          sbit led4 = P0^7;
  19          sbit led5 = P2^4;
  20          sbit led6 = P2^5;
  21          sbit led7 = P2^0;
  22          sbit led8 = P2^3;
  23          u8 counter=0;//timer0 计数
  24          
  25          //压线标志位
  26          bit L1=0;//最右侧标志位
  27          bit L2=0;
  28          bit L3=0;
  29          bit L4=0;//最左侧标志位
  30          
  31          u8 flag=0;
  32          
  33          
  34          extern u8 pwm0,pwm1,pwm2;
  35          
  36          /***************************向前走*****************************/
  37          void forward() 
  38          {
  39   1          pwm_left(speed);
  40   1          pwm_right(speed);
  41   1      }
  42          /**************************停止*****************************/
  43          void stop() {pwm_left(0); pwm_right(0);}  
  44          
  45          /*左转90度，自动恢复*/
  46          void turn_left()
  47          {
  48   1        //调试参数修改转弯模式
  49   1          pwm_left(0);
  50   1          pwm_right(speed);
  51   1        //调试参数，1-255
  52   1          delay_ms(2000);
  53   1          pwm_left(speed);
  54   1          pwm_right(speed);
  55   1      }
C51 COMPILER V9.52.0.0   MAIN                                                              04/07/2016 17:40:32 PAGE 2   

  56          
  57          /*右转90度，自动恢复*/
  58          void turn_right()
  59          {
  60   1        //调试参数修改转弯模式
  61   1          pwm_left(speed);
  62   1          pwm_right(0);
  63   1        //调试参数，0-65536
  64   1          delay_ms(2000);
  65   1          pwm_left(speed);
  66   1          pwm_right(speed);
  67   1      }
  68          
  69          void adjust_left()
  70          {
  71   1        u8 temp=TLIN;
  72   1          pwm_left(0);
  73   1          pwm_right(speed);
  74   1        //????????
  75   1        //??????
  76   1        //??130 delay_ms(100)
  77   1        //??170 delay_ms(180) 1?150 too samll
  78   1        //
  79   1          delay_ms(220);
  80   1          //?????
  81   1          for(;temp!=0xf0;temp=TLIN)//???????
  82   1          {
  83   2          }
  84   1          //??
  85   1          pwm_left(speed);
  86   1          pwm_right(0);
  87   1          //????
  88   1          delay_ms(200);
  89   1          //????
  90   1          pwm_left(speed);
  91   1          pwm_right(speed);
  92   1          return;
  93   1          
  94   1      }
  95          void adjust_right()
  96          {
  97   1          u8 temp=TLIN;
  98   1          pwm_left(speed);
  99   1          pwm_right(0);
 100   1        //????????
 101   1        //??????
 102   1        //??130 delay_ms(100)
 103   1        //??170 delay_ms(180) 1?150 too samll
 104   1        //
 105   1          delay_ms(200);
 106   1          //?????
 107   1          for(;temp!=0xf0;temp=TLIN)//???????
 108   1          {
 109   2        //    delay_ms(10);
 110   2          }
 111   1          //??
 112   1          pwm_left(0);
 113   1          pwm_right(speed);
 114   1          //????
 115   1          delay_ms(150);
 116   1          //????
 117   1          pwm_left(speed);
C51 COMPILER V9.52.0.0   MAIN                                                              04/07/2016 17:40:32 PAGE 3   

 118   1          pwm_right(speed);
 119   1          return;
 120   1      
 121   1      }
 122          
 123          /************************
 124          //左转可调，自动恢复
 125          //t1:保持左转状态时间 1-255
 126          //t2:回调时间 1-255
 127          *************************/
 128          void turn_leftn(u16 t1,u16 t2)
 129          {
 130   1        //调试参数修改转弯模式
 131   1          pwm_left(0);
 132   1          pwm_right(speed);
 133   1        //:保持左转状态时间
 134   1          delay_ms(t1);
 135   1          //回调
 136   1          //回调时pwm比需要计算、调试
 137   1          pwm_left(speed);
 138   1          pwm_right(0);
 139   1            //回调时间
 140   1          delay_ms(t2);
 141   1          //恢复前行
 142   1          pwm_left(speed);
 143   1          pwm_right(speed);
 144   1      }
 145          
 146          /************************
 147          //右转可调，支持转弯后回调
 148          //t1:保持右转状态时间 1-255
 149          //t2:回调时间 1-255
 150          *************************/
 151          void turn_rightn(u16 t1,u16 t2)
 152          {
 153   1        
 154   1        //调试参数修改转弯模式
 155   1          pwm_left(speed);
 156   1          pwm_right(0);
 157   1        //保持右转状态时间
 158   1          delay_ms(t1);
 159   1          
 160   1          //回调
 161   1          //回调时pwm比需要计算、调试
 162   1          pwm_left(0);
 163   1          pwm_right(speed);
 164   1            //回调时间
 165   1          delay_ms(t2);
 166   1          
 167   1          //恢复前行
 168   1          pwm_left(speed);
 169   1          pwm_right(speed);
 170   1      
 171   1      }
 172          
 173          /*****************************检测前面是否有小车*******************************/
 174          
 175          void check()
 176          {
 177   1        if(k==1)
 178   1          g=1;
 179   1        else 
C51 COMPILER V9.52.0.0   MAIN                                                              04/07/2016 17:40:32 PAGE 4   

 180   1          g=0;
 181   1      }
 182          
 183          
 184          void Inline()   //检测黑线信号，检测到黑线时变为高电平，平时低电平
 185          {
 186   1        switch(TLIN)
 187   1        {
 188   2          //没检测到黑线时，直行
 189   2          case 0x00:    forward();    break;
 190   2          
 191   2          //仅右边检测到黑线时，左电机快转，右电机慢转
 192   2          case 0x01:  stop();         break;
 193   2          
 194   2          //仅中间检测到黑线时，正常，左右电机都快转
 195   2          case 0x02:                  break;
 196   2          
 197   2          //中间以及右边检测到黑线时，左电机快转，右电机慢转
 198   2          case 0x03:                  break;
 199   2          
 200   2          //仅左边检测到黑线时，左电机慢转，右电机快转
 201   2          case 0x04:      stop();             break;
 202   2          
 203   2          case 0x05:  break;  //不可能出现此情况
 204   2          
 205   2          //中间以及左边检测到黑线时，左电机慢转，右电机快转
 206   2          case 0x06:  break;  
 207   2          
 208   2          //全都检测到黑线时
 209   2          case 0x07:      
 210   2            forward();
 211   2        break;
 212   2          default: break;
 213   2          
 214   2        }
 215   1          
 216   1      }
 217          
 218          /*************************主函数***********************************/
 219          main()
 220          { 
 221   1        PCA_Init();//pwm初始化
 222   1        Timer_config();
 223   1        check();//初始化检测前方小车
 224   1        forward(); //直行
 225   1        
 226   1        //调试用 1-255
 227   1        delay_ms(200);
 228   1        while(1)
 229   1        { 
 230   2          Inline();
 231   2        //  pwm_left(speed);
 232   2        //  pwm_right(0);
 233   2      
 234   2         }
 235   1       }
 236          
 237          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    390    ----
C51 COMPILER V9.52.0.0   MAIN                                                              04/07/2016 17:40:32 PAGE 5   

   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =      3      10
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      4    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
